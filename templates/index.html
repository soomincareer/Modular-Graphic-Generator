<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GridLab</title>

  <style>
    @font-face {
      font-family: 'Superlative';
      src: url('/static/fonts/Superlative-RegularCondensed.woff') format('woff');
      font-weight: normal;
      font-style: normal;
    }

    @font-face {
      font-family: 'Superlative Regular';
      src: url('/static/fonts/Superlative-Regular.woff') format('woff');
      font-weight: normal;
      font-style: normal;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Superlative', sans-serif;
      background: #000000;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 960px;
      margin: 0 auto;
      background: #ffffff;
      border: 2px solid #000000;
      overflow: hidden;
    }

    /* ===== Header ===== */
    .header {
      background: #000000;
      color: #ffffff;
      padding: 26px 24px 22px;
      border-bottom: 2px solid #000000;
      display: grid;
      place-items: center;
      gap: 14px;
      text-align: center;
    }

    .header h1 {
      font-size: clamp(28px, 5vw, 44px);
      margin: 0;
      font-weight: normal;
      font-family: 'Superlative Regular', sans-serif;
      letter-spacing: 0.2px;
    }

    .header p {
      opacity: 1;
      font-size: clamp(14px, 2.2vw, 18px);
      font-weight: normal;
    }

    /* Hero visual (square frame) */
    .heroVisual {
      width: min(960px, 74vw);
      aspect-ratio: 2 / 1;
      border: 2px solid #ffffff;
      background: #ffffff;
      overflow: hidden;
    }

    #heroCanvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    /* ===== Content ===== */
    .content {
      padding: 26px;
      background: #ffffff;
    }

    .section {
      margin-bottom: 22px;
      border: 2px solid #000000;
      padding: 18px;
      background: #ffffff;
    }

    .section h2 {
      color: #000000;
      margin-bottom: 14px;
      font-size: 1.2em;
      border-bottom: 2px solid #000000;
      padding-bottom: 10px;
      font-weight: normal;
      font-family: 'Superlative Regular', sans-serif;
    }

    .form-group { margin-bottom: 18px; }

    .form-group label {
      display: block;
      font-weight: normal;
      margin-bottom: 10px;
      color: #000000;
      font-family: 'Superlative', sans-serif;
    }

    .form-group input[type="text"],
    .form-group input[type="number"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #000000;
      border-radius: 0;
      font-size: 16px;
      transition: border-color 0.3s;
      font-family: 'Superlative', sans-serif;
      background: #DDDDDD;
    }

    .form-group input:focus {
      outline: none;
      border-color: #000000;
      background: #f5f5f5;
    }

    .file-input-wrapper { position: relative; display: inline-block; width: 100%; }
    .file-input-wrapper input[type="file"] { display: none; }

    .file-input-label {
      display: block;
      padding: 14px 18px;
      background: #AFAFAF;
      color: #ffffff;
      border: 2px solid #515151;
      border-radius: 0;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'Superlative', sans-serif;
      font-weight: normal;
      user-select: none;
    }

    .file-input-label:hover {
      background: #000000;
      color: #ffffff;
      border-color: #000000;
    }

    .file-input-label.has-files {
      background: #000000;
      border-color: #000000;
      color: #ffffff;
    }

    .btn {
      padding: 15px 30px;
      border: 2px solid #000000;
      border-radius: 0;
      font-size: 16px;
      font-weight: normal;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-block;
      font-family: 'Superlative', sans-serif;
    }

    .btn-primary { background: #000000; color: #ffffff; }
    .btn-primary:hover { background: #ffffff; color: #000000; border-color: #000000; }
    .btn-primary:disabled { opacity: 0.3; cursor: not-allowed; }

    .btn-secondary {
      background: #ffffff;
      color: #000000;
      border: 2px solid #000000;
      margin-left: 10px;
    }
    .btn-secondary:hover { background: #000000; color: #ffffff; }

    /* Previews */
    .module-preview, .image-preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
      margin-top: 14px;
    }

    .module-item, .image-item {
      background: #ffffff;
      border: 2px solid #000000;
      border-radius: 0;
      padding: 10px;
      text-align: center;
      transition: all 0.3s;
      position: relative;
    }

    .module-item:hover, .image-item:hover {
      background: #000000;
      color: #ffffff;
    }

    .module-item:hover .filename,
    .module-item:hover .brightness,
    .image-item:hover .filename {
      color: #ffffff;
    }

    .module-item img, .image-item img {
      width: 100%;
      height: 120px;
      object-fit: contain;
      border-radius: 0;
      background: #ffffff;
      margin-bottom: 8px;
      border: 1px solid #000000;
    }

    .filename {
      font-size: 12px;
      color: #000000;
      word-break: break-all;
      margin-bottom: 5px;
      font-family: 'Superlative', sans-serif;
    }

    .brightness {
      font-size: 11px;
      color: #000000;
      font-weight: normal;
      font-family: 'Superlative', sans-serif;
    }

    .remove-btn {
      position: absolute;
      top: 6px;
      right: 6px;
      background: #000000;
      color: #ffffff;
      border: 2px solid #000000;
      border-radius: 0;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      font-family: 'Superlative', sans-serif;
    }

    .remove-btn:hover { background: #ffffff; color: #000000; }

    .loading {
      text-align: center;
      padding: 40px;
      display: none;
    }
    .loading.active { display: block; }

    .spinner {
      border: 4px solid #ffffff;
      border-top: 4px solid #000000;
      border-radius: 0;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .result-section { display: none; margin-top: 24px; }
    .result-section.active { display: block; }

    .alert {
      padding: 15px 20px;
      border-radius: 0;
      margin-bottom: 20px;
      border: 2px solid #000000;
      font-family: 'Superlative', sans-serif;
    }
    .alert-error { background: #ffffff; color: #000000; border: 2px solid #000000; }
    .alert-success { background: #000000; color: #ffffff; border: 2px solid #000000; }

    .grid-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    /* Output viewer */
    .image-viewer {
      margin-top: 18px;
      border: 2px solid #000000;
      padding: 18px;
      background: #ffffff;
    }
    .image-viewer h3 {
      font-family: 'Superlative Regular', sans-serif;
      margin-bottom: 12px;
      font-weight: normal;
    }
    .image-display {
      text-align: center;
      margin: 16px 0;
      background: #f5f5f5;
      border: 2px solid #000000;
      padding: 16px;
      min-height: 320px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .image-display img {
      max-width: 100%;
      max-height: 560px;
      object-fit: contain;
      border: 1px solid #000000;
      background: #ffffff;
    }

    .image-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 14px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .image-nav-btn {
      padding: 10px 16px;
      background: #000000;
      color: #ffffff;
      border: 2px solid #000000;
      border-radius: 0;
      cursor: pointer;
      font-family: 'Superlative', sans-serif;
      transition: all 0.3s;
    }
    .image-nav-btn:hover:not(:disabled) { background: #ffffff; color: #000000; }
    .image-nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }

    .image-counter { font-family: 'Superlative', sans-serif; font-size: 16px; }

    .toggle-btn {
      padding: 10px 16px;
      background: #ffffff;
      color: #000000;
      border: 2px solid #000000;
      border-radius: 0;
      cursor: pointer;
      font-family: 'Superlative', sans-serif;
      margin-top: 10px;
      transition: all 0.3s;
    }
    .toggle-btn:hover { background: #000000; color: #ffffff; }

    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
    .collapsible-content.active {
      max-height: 1200px;
      transition: max-height 0.5s ease-in;
    }

    .download-image-btn {
      padding: 10px 16px;
      background: #000000;
      color: #ffffff;
      border: 2px solid #000000;
      border-radius: 0;
      cursor: pointer;
      font-family: 'Superlative', sans-serif;
      transition: all 0.3s;
    }
    .download-image-btn:hover { background: #ffffff; color: #000000; }

    .markdown-preview {
      background: #ffffff;
      border: 2px solid #000000;
      border-radius: 0;
      padding: 16px;
      max-height: 600px;
      overflow-y: auto;
      font-size: 14px;
      font-family: 'Superlative', sans-serif;
      margin-top: 12px;
    }
    .markdown-preview h1, .markdown-preview h2 {
      font-family: 'Superlative Regular', sans-serif;
      font-weight: normal;
      color: #000000;
    }
    .markdown-preview table {
      width: 100%;
      border-collapse: collapse;
      margin: 16px 0;
    }
    .markdown-preview th, .markdown-preview td {
      padding: 10px;
      border: 1px solid #000000;
      text-align: left;
    }
    .markdown-preview th { background: #000000; color: #ffffff; }
    .markdown-preview img {
      max-width: 200px;
      max-height: 200px;
      object-fit: contain;
      border: 1px solid #000000;
    }

    /* Mobile tweaks */
    @media (max-width: 640px) {
      body { padding: 12px; }
      .content { padding: 16px; }
      .section { padding: 14px; }
      .grid-inputs { grid-template-columns: 1fr; }
      .heroVisual { width: min(300px, 86vw); }
      .image-display { min-height: 260px; }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>GridLab</h1>
      <p>Generate images from modules.</p>
      <div class="heroVisual" aria-hidden="true">
        <canvas id="heroCanvas"></canvas>
      </div>
    </div>

    <div class="content">

      <!-- Modules -->
      <div class="section">
        <h2>Modules</h2>
        <div class="file-input-wrapper">
          <input type="file" id="moduleFiles" multiple accept="image/*">
          <label for="moduleFiles" class="file-input-label" id="moduleLabel">Upload images</label>
        </div>
        <div id="modulePreview" class="module-preview"></div>
      </div>

      <!-- Image -->
      <div class="section">
        <h2>Image</h2>
        <div class="file-input-wrapper">
          <input type="file" id="imageFiles" multiple accept="image/*">
          <label for="imageFiles" class="file-input-label" id="imageLabel">Upload images</label>
        </div>
        <div id="imagePreview" class="image-preview"></div>
      </div>

      <!-- Grid -->
      <div class="section">
        <h2>Grid</h2>
        <div class="grid-inputs">
          <div class="form-group">
            <label>Grid Size</label>
            <input type="text" id="gridSize" value="64x40" placeholder="e.g. 64x40">
          </div>
          <div class="form-group">
            <label>Output DPI</label>
            <input type="number" id="outputDpi" value="600" min="72" max="1200">
          </div>
        </div>
      </div>

      <div class="section" style="text-align:center; border:none; padding: 0; background: transparent;">
        <button class="btn btn-primary" id="generateBtn" disabled>Generate</button>
      </div>

      <!-- Loading -->
      <div class="loading" id="loadingSection">
        <div class="spinner"></div>
        <p>Generating…</p>
      </div>

      <!-- Output -->
      <div class="result-section" id="resultSection">
        <h2>Output</h2>
        <div id="alertBox"></div>

        <div class="image-viewer">
          <h3>Generated Images</h3>
          <div class="image-display" id="imageDisplay">
            <p>No images to display</p>
          </div>

          <div class="image-controls">
            <button class="image-nav-btn" id="prevBtn" disabled>&larr; Previous</button>
            <span class="image-counter" id="imageCounter">0 / 0</span>
            <button class="image-nav-btn" id="nextBtn" disabled>Next &rarr;</button>
          </div>

          <div style="text-align:center; margin-top: 14px;">
            <button class="download-image-btn" id="downloadCurrentImageBtn" style="display:none;">Download Current</button>
            <button class="download-image-btn" id="downloadAllImagesBtn" style="display:none; margin-left: 10px;">Download All</button>
          </div>
        </div>

        <div style="text-align:center; margin-top: 18px;">
          <button class="toggle-btn" id="toggleDetailsBtn">Show Detailed Statistics</button>
        </div>

        <div class="collapsible-content" id="detailsContent">
          <div class="form-group" style="margin-top: 14px; text-align:center;">
            <button class="btn btn-secondary" id="downloadMdBtn">Download total.md</button>
            <button class="btn btn-secondary" id="downloadResultsBtn">Download Results (ZIP)</button>
          </div>
          <div class="markdown-preview" id="markdownPreview"></div>
        </div>
      </div>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    /* ===== Hero animation: grid + diagonal waves (feather + seamless loop) ===== */
    (() => {
      const canvas = document.getElementById('heroCanvas');
      if (!canvas) return;

      const prefersReduced = window.matchMedia?.('(prefers-reduced-motion: reduce)')?.matches;
      if (prefersReduced) return;

      const ctx = canvas.getContext('2d', { alpha: false });

      // ====== Tuning values ======
      const GRID = 40;          // 20x20
      const BORDER = 1;         // stroke px

      const WAVE_WIDTH = 1;     // wave thickness in tile units
      const WAVE_COUNT = 6;
      const WAVE_SPACING = 6;

      const SPEED = 12;
      const SOFTNESS = 2;
      const DIAGONAL = 1;
      const FPS_CAP = 42;

      const FEATHER_GAMMA = 1.5;
      // ==========================

      let w = 0, h = 0, dpr = 1;
      let tile = 0;
      let t = 0;
      let raf = 0;
      let last = 0;

      function resize() {
        dpr = Math.min(window.devicePixelRatio || 1, 2);
        w = canvas.clientWidth;
        h = canvas.clientHeight;

        canvas.width = Math.floor(w * dpr);
        canvas.height = Math.floor(h * dpr);
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

        tile = Math.floor(Math.min(w, h) / GRID);
      }

      function smoothstep(a, b, x) {
        const tt = Math.max(0, Math.min(1, (x - a) / (b - a)));
        return tt * tt * (3 - 2 * tt);
      }

      function wrap01(v, m) { return ((v % m) + m) % m; }

      function draw(ts) {
        if (!last) last = ts;
        const dt = ts - last;
        if (dt < 1000 / FPS_CAP) {
          raf = requestAnimationFrame(draw);
          return;
        }
        last = ts;

        t += 0.016 * SPEED;

        // white base
        ctx.fillStyle = '#fff';
        ctx.fillRect(0, 0, w, h);

        const frameW = GRID * tile;
        const frameH = GRID * tile;
        const ox = Math.floor((w - frameW) / 2);
        const oy = Math.floor((h - frameH) / 2);

        // seamless loop
        const LOOP = WAVE_SPACING * WAVE_COUNT;
        const phaseWrapped = wrap01(t, LOOP);

        // fill tiles
        for (let r = 0; r < GRID; r++) {
          for (let c = 0; c < GRID; c++) {
            const x = ox + c * tile;
            const y = oy + r * tile;

            const diag = c + DIAGONAL * r;
            const diagWrapped = wrap01(diag, LOOP);

            let minDist = Infinity;
            for (let k = 0; k < WAVE_COUNT; k++) {
              const center = wrap01(phaseWrapped + k * WAVE_SPACING, LOOP);
              const raw = Math.abs(diagWrapped - center);
              const dist = Math.min(raw, LOOP - raw);
              if (dist < minDist) minDist = dist;
            }

            const edge0 = WAVE_WIDTH - SOFTNESS;
            const edge1 = WAVE_WIDTH + SOFTNESS;
            const inside = 1 - smoothstep(edge0, edge1, minDist);

            if (inside > 0.001) {
              const alpha = Math.min(1, Math.max(0, Math.pow(inside, FEATHER_GAMMA)));
              ctx.fillStyle = `rgba(0,0,0,${alpha})`;
              ctx.fillRect(x, y, tile, tile);
            }
          }
        }

        // grid stroke
        ctx.lineWidth = BORDER;
        ctx.strokeStyle = '#000';
        ctx.beginPath();

        for (let c = 0; c <= GRID; c++) {
          const xx = ox + c * tile + 0.5;
          ctx.moveTo(xx, oy);
          ctx.lineTo(xx, oy + frameH);
        }
        for (let r = 0; r <= GRID; r++) {
          const yy = oy + r * tile + 0.5;
          ctx.moveTo(ox, yy);
          ctx.lineTo(ox + frameW, yy);
        }
        ctx.stroke();

        raf = requestAnimationFrame(draw);
      }

      function onVis() {
        if (document.hidden) {
          cancelAnimationFrame(raf);
          raf = 0;
          last = 0;
        } else if (!raf) {
          last = 0;
          raf = requestAnimationFrame(draw);
        }
      }

      window.addEventListener('resize', resize);
      document.addEventListener('visibilitychange', onVis);

      resize();
      raf = requestAnimationFrame(draw);
    })();


    /* ===== App logic (original behavior preserved) ===== */

    // file stores
    let moduleFileList = new DataTransfer();
    let imageFileList = new DataTransfer();

    // DOM
    const moduleFilesInput = document.getElementById('moduleFiles');
    const imageFilesInput  = document.getElementById('imageFiles');
    const moduleLabel = document.getElementById('moduleLabel');
    const imageLabel  = document.getElementById('imageLabel');
    const generateBtn = document.getElementById('generateBtn');
    const modulePreview = document.getElementById('modulePreview');
    const imagePreview  = document.getElementById('imagePreview');

    moduleFilesInput.addEventListener('change', async (e) => {
      if (e.target.files.length === 0) {
        e.target.files = moduleFileList.files;
        return;
      }

      for (let file of e.target.files) {
        let isDuplicate = false;
        for (let existingFile of moduleFileList.files) {
          if (existingFile.name === file.name && existingFile.size === file.size) {
            isDuplicate = true; break;
          }
        }
        if (!isDuplicate) moduleFileList.items.add(file);
      }

      e.target.files = moduleFileList.files;

      updateModuleUI();
      await analyzeModules();
      checkFormValid();
    });

    imageFilesInput.addEventListener('change', (e) => {
      if (e.target.files.length === 0) {
        e.target.files = imageFileList.files;
        return;
      }

      for (let file of e.target.files) {
        let isDuplicate = false;
        for (let existingFile of imageFileList.files) {
          if (existingFile.name === file.name && existingFile.size === file.size) {
            isDuplicate = true; break;
          }
        }
        if (!isDuplicate) imageFileList.items.add(file);
      }

      e.target.files = imageFileList.files;

      updateImageUI();
      checkFormValid();
    });

    function updateModuleUI() {
      const count = moduleFileList.files.length;
      if (count > 0) {
        moduleLabel.textContent = `${count} modules selected`;
        moduleLabel.classList.add('has-files');
      } else {
        moduleLabel.textContent = 'Upload images';
        moduleLabel.classList.remove('has-files');
      }
    }

    function updateImageUI() {
      const count = imageFileList.files.length;
      if (count > 0) {
        imageLabel.textContent = `${count} images selected`;
        imageLabel.classList.add('has-files');
      } else {
        imageLabel.textContent = 'Upload images';
        imageLabel.classList.remove('has-files');
      }

      imagePreview.innerHTML = '';
      for (let i = 0; i < imageFileList.files.length; i++) {
        const file = imageFileList.files[i];
        const item = document.createElement('div');
        item.className = 'image-item';

        const reader = new FileReader();
        reader.onload = (ev) => {
          item.innerHTML = `
            <button class="remove-btn" onclick="removeImageFile(${i})" title="Remove">×</button>
            <img src="${ev.target.result}" alt="${file.name}">
            <div class="filename">${file.name}</div>
          `;
        };
        reader.readAsDataURL(file);

        imagePreview.appendChild(item);
      }
    }

    function removeModuleFile(index) {
      const newFileList = new DataTransfer();
      for (let i = 0; i < moduleFileList.files.length; i++) {
        if (i !== index) newFileList.items.add(moduleFileList.files[i]);
      }
      moduleFileList = newFileList;
      moduleFilesInput.files = moduleFileList.files;

      updateModuleUI();
      analyzeModules();
      checkFormValid();
    }

    function removeImageFile(index) {
      const newFileList = new DataTransfer();
      for (let i = 0; i < imageFileList.files.length; i++) {
        if (i !== index) newFileList.items.add(imageFileList.files[i]);
      }
      imageFileList = newFileList;
      imageFilesInput.files = imageFileList.files;

      updateImageUI();
      checkFormValid();
    }

    function checkFormValid() {
      const hasModules = moduleFileList.files.length > 0;
      const hasImages  = imageFileList.files.length > 0;
      generateBtn.disabled = !(hasModules && hasImages);
    }

    // analyze modules
    async function analyzeModules() {
      if (moduleFileList.files.length === 0) {
        modulePreview.innerHTML = '';
        return;
      }

      const formData = new FormData();
      for (let file of moduleFileList.files) formData.append('module_files', file);

      try {
        const response = await fetch('/api/analyze-modules', { method: 'POST', body: formData });
        const data = await response.json();

        if (data.success) {
          modulePreview.innerHTML = '';
          data.modules.forEach((module, index) => {
            const item = document.createElement('div');
            item.className = 'module-item';
            item.innerHTML = `
              <button class="remove-btn" onclick="removeModuleFile(${index})" title="Remove">×</button>
              <img src="data:image/png;base64,${module.image}" alt="${module.filename}">
              <div class="filename">${module.filename}</div>
              <div class="brightness">Brightness: ${module.brightness.toFixed(1)}</div>
            `;
            modulePreview.appendChild(item);
          });
        } else {
          alert('Module analysis failed: ' + data.error);
        }
      } catch (error) {
        console.error('Error analyzing modules:', error);
        alert('An error occurred while analyzing modules.');
      }
    }

    // output viewer state
    let generatedImages = [];
    let currentImageIndex = 0;

    function updateImageViewer() {
      const imageDisplay = document.getElementById('imageDisplay');
      const imageCounter = document.getElementById('imageCounter');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const downloadBtn = document.getElementById('downloadCurrentImageBtn');
      const downloadAllBtn = document.getElementById('downloadAllImagesBtn');

      if (generatedImages.length === 0) {
        imageDisplay.innerHTML = '<p>No images to display</p>';
        imageCounter.textContent = '0 / 0';
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        downloadBtn.style.display = 'none';
        downloadAllBtn.style.display = 'none';
        return;
      }

      const currentImage = generatedImages[currentImageIndex];
      imageDisplay.innerHTML = `<img src="/outputs/${currentImage}" alt="Generated Image ${currentImageIndex + 1}">`;
      imageCounter.textContent = `${currentImageIndex + 1} / ${generatedImages.length}`;

      prevBtn.disabled = currentImageIndex === 0;
      nextBtn.disabled = currentImageIndex === generatedImages.length - 1;
      downloadBtn.style.display = 'inline-block';
      downloadAllBtn.style.display = 'inline-block';
    }

    document.getElementById('prevBtn').addEventListener('click', () => {
      if (currentImageIndex > 0) { currentImageIndex--; updateImageViewer(); }
    });

    document.getElementById('nextBtn').addEventListener('click', () => {
      if (currentImageIndex < generatedImages.length - 1) { currentImageIndex++; updateImageViewer(); }
    });

    document.getElementById('downloadCurrentImageBtn').addEventListener('click', () => {
      if (generatedImages.length > 0) {
        const currentImage = generatedImages[currentImageIndex];
        const link = document.createElement('a');
        link.href = `/outputs/${currentImage}`;
        link.download = currentImage;
        link.click();
      }
    });

    document.getElementById('downloadAllImagesBtn').addEventListener('click', () => {
      if (generatedImages.length === 0) return;
      window.location.href = '/api/download-results';
    });

    document.getElementById('toggleDetailsBtn').addEventListener('click', () => {
      const detailsContent = document.getElementById('detailsContent');
      const toggleBtn = document.getElementById('toggleDetailsBtn');

      if (detailsContent.classList.contains('active')) {
        detailsContent.classList.remove('active');
        toggleBtn.textContent = 'Show Detailed Statistics';
      } else {
        detailsContent.classList.add('active');
        toggleBtn.textContent = 'Hide Detailed Statistics';
      }
    });

    document.getElementById('downloadMdBtn').addEventListener('click', () => {
      window.location.href = '/api/download-md';
    });

    document.getElementById('downloadResultsBtn').addEventListener('click', () => {
      window.location.href = '/api/download-results';
    });

    // Generate
    generateBtn.addEventListener('click', async () => {
      const loadingSection = document.getElementById('loadingSection');
      const resultSection = document.getElementById('resultSection');
      const alertBox = document.getElementById('alertBox');
      const markdownPreview = document.getElementById('markdownPreview');

      loadingSection.classList.add('active');
      resultSection.classList.remove('active');
      generateBtn.disabled = true;

      const formData = new FormData();
      for (let file of moduleFileList.files) formData.append('module_files', file);
      for (let file of imageFileList.files) formData.append('target_files', file); // backend expects target_files

      formData.append('grid_size', document.getElementById('gridSize').value);
      formData.append('output_dpi', document.getElementById('outputDpi').value);

      try {
        const response = await fetch('/api/generate', { method: 'POST', body: formData });
        const data = await response.json();

        loadingSection.classList.remove('active');
        resultSection.classList.add('active');

        if (data.success) {
          alertBox.innerHTML = `
            <div class="alert alert-success">
              Generation complete! ${data.output_count} files created.
            </div>
          `;

          generatedImages = data.output_files || [];
          currentImageIndex = 0;
          updateImageViewer();

          markdownPreview.innerHTML = marked.parse(data.total_md);
        } else {
          alertBox.innerHTML = `
            <div class="alert alert-error">
              Error: ${data.error}
            </div>
          `;
        }
      } catch (error) {
        console.error('Error generating:', error);
        loadingSection.classList.remove('active');
        resultSection.classList.add('active');
        alertBox.innerHTML = `
          <div class="alert alert-error">
            An error occurred during generation: ${error.message}
          </div>
        `;
      } finally {
        generateBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
